# How to sync LDAP with Active Directory

### Prerequisite
* Active Directory Server 
* LDAP Server 
* Both Active Directory and LDAP should have same org structure which we need to sync 

#### 1. Enable memberOf attribute in LDAP after downloading ldif files from [here](https://github.com/vikramjakhr/ADtoLDAP/tree/master/ldifs)
```
ldapadd -Q -Y EXTERNAL -H ldapi:/// -f memberof_load_configure.ldif 
ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f 1refint.ldif
ldapadd -Q -Y EXTERNAL -H ldapi:/// -f 2refint.ldif
```

#### 2. Download ADtoLDAP binary
* Download the binary
```
wget https://raw.githubusercontent.com/vikramjakhr/ADtoLDAP/master/ADtoLDAP
```

#### 3. Configuration for ADtoLDAP
* Create log file
```
touch /var/log/ldapsync.log
```

* Create config file
```
touch /etc/ldapsync.ini
```
* Copy & paste the sample ldapsync configuration from [here](#sample-ldapsync-config) in /etc/ldapsync.ini

* Change permission of /etc/ldapsync.ini
```
chmod 600 /etc/ldapsync.ini
```

#### 4. Run the ADtoLDAP binary with below command
```
nohup ./ADtoLDAP > log.out 2>&1 &
```

PS: forked repo [here](https://github.com/nohupped/ADtoLDAP)

##### sample ldapsync config

```
### Sample config generated by the program. Edit accordingly ###
[ADServer]
Host = <host>
ADPort = 389
Port = 389
UseTLS = false
# set InsecureSkipVerify to true for testing, to accept the certificate without any verification.
InsecureSkipVerify = true
#CRTValidFor will not be honored if InsecureSkipVerify is set to true.
CRTValidFor = example1.domain.com
#Path to the pem file, which is used to create the custom CA pool. Will not be honored if InsecureSkipVerify is set to true.
#CRTPath = /etc/ldap.crt
#Page the result size to prevent possible OOM error and crash
Page = 500
#AD Connection Timeout in seconds (Defaults to 10)
ConnTimeOut = 10
username = CN=Administrator,CN=Users,DC=example,DC=com
password = <password>
basedn = ou=xyz,dc=example,dc=com
#Attributes required to be pulled
attr = givenName, unixHomeDirectory, sn, loginShell, memberOf, dn, o, uid, objectclass, cn, displayName, cn, uidNumber, gidNumber, member
#ldap filter
filter = (cn=*)

[LDAPServer]
Host = <host>
Port = 389
UseTLS = false
InsecureSkipVerify = true
CRTValidFor = ldapserver.example.com
#CRTPath = /etc/ldap/sasl2/server.crt
#Page LDAP result
Page = 500
#LDAP Connection Timeout in seconds (Defaults to 10)
ConnTimeOut = 10
username = cn=admin,dc=example,dc=com
password = <password>
basedn = ou=xyz,dc=example,dc=com
attr = givenName, homeDirectory, sn, loginShell, memberOf, dn, o, uid, objectclass, cn, displayName, cn, uidNumber, gidNumber, memberUid
filter = (cn=*)


[Replace]
userObjectClass = top,inetOrgPerson
groupObjectClass = top,posixGroup
[Map]
#ADAttribute = ldapattribute, that is mapping AD attribute to the relevant ldap attribute
unixHomeDirectory = homeDirectory
#specify member mapping if you are selecting member attribute from *attr above
member = memberUid

[Sync]
#Add sleep time after each successful sync, in seconds.
sleepTime = 5
# loglevel can be set to either of
#   ErrorLevel = iota // 0
#   WarnLevel // 1
#   InfoLevel // 2
#   DebugLevel // 3
# Uncomment the below line and set to desired value. Defaults to DebugLevel.
# loglevel = DebugLevel
```